---
layout: post
title: "k8s 笔记(四) 控制器"
date: 2020-03-15 00:23:11 +0800
category: k8s
tags: [k8s]
---
* content
{:toc}

# 1. 控制器介绍

> ReplicaSet 是下一代的 Replication Controller。 ReplicaSet 和 Replication Controller 的唯一区别是选择器的支持。 ReplicaSet 支持新的基于集合的选择器（selector）需求
> 

## 1.1. ReplicaSet 示例

ReplicaSet 确保任何时间都有指定数量的 Pod 副本在运行。 然而 Deployment 是一个更高级的概念，它管理 ReplicaSet， 并向 Pod 提供声明式的更新以及许多其他有用的功能。 因此，更建议使用 Deploymen。

示例:

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: frontend
  labels:
    app: guestbook
    tier: frontend
spec:
  # 3个副本数
  replicas: 3
  selector:
    matchLabels:
      tier: frontend
    matchExpressions:
      - { key: tier,operator: In, values:[frontend]}
  template:
    metadata:
      labels:
        app: guestbook
        tier: frontend
    spec:
      containers:
      - name: php-redis
        image: gcr.io/google_samples/gb-frontend:v3
        resources:
          requests:
            cpu: 100m
            memory: 100Mi
        env:
        - name: GET_HOSTS_FROM
          value: dns
        ports:
        - containerPort: 80
```

将资源清单保存到`frontend.yaml` 中，执行 `kubectl create -f frontend.yaml` 就可以看到对应的 pod已经创建

```
$ kubectl get rs --show-labels=true  -l app=guestbook
NAME       DESIRED   CURRENT   READY   AGE   LABELS
frontend   3         3         3       25m   app=guestbook,tier=frontend

$ kubectl get pod --show-labels=true -l app=guestbook
NAME             READY   STATUS    RESTARTS   AGE   LABELS
frontend-82tvl   1/1     Running   0          25m   app=guestbook,tier=frontend
frontend-q878l   1/1     Running   0          25m   app=guestbook,tier=frontend
frontend-wh7n4   1/1     Running   0          25m   app=guestbook,tier=frontend
```

## 1.2. 编写 ReplicaSet Spec

与所有其他Kubernetes API 对象一样， ReplicaSet 也需要 `apiVersion` `kind` `metadata` `spec` 字段

- **Pod 模板**

	`.spec.template` 是 `.spec` 唯一需求的字段。
	
	`.spec.template` 是 Pod 模板，和 Pod 的语法完全一样，只需要将 Pod 的`metadata`和`spec`语法嵌套进去就可以了.

	**重启策略：** `spec.template.spec.restartPolicy` 唯一允许 `Always`


- **Pod 选择器**
	
	`.spec.seletor` 字段是标签选择器。ReplicaSet 管理所有与标签选择器匹配的Pod。 它不区分是否为自己创建的Pod。 这允许在不影响运行中的 Pod 的情况下替换副本集. `.spec.template.metadata.labels` 必须匹配 `.spec.selector`, 否则它将被 API 拒绝。
	
	通常不应该创建标签与此选择器匹配的任何Pod，或者直接与另一个 ReplicaSet 或 另一个控制器（如 Deployment） 标签匹配的任何Pod ， 如果这样做， ReplicaSet 会认为它创造了其他 Pod 。 kubernetes 并不会阻止你这样做。
	
	示例：
	
	```
	$ cat pod.yaml
	apiVersion: v1
	kind: Pod
	metadata:
	  name: frontend-test
	  labels:
	    app: guestbook
	    tier: frontend
	spec:
	  containers:
	  - name: frontend-test
	    image: harbor.tansuotv.cn/library/nginx:v1
	    
	$ kubectl create -f pod.yaml
	pod/frontend-test created

	$ kubectl get pod  --show-labels=true -l app=guestbook
	NAME             READY   STATUS        RESTARTS   AGE   LABELS
	frontend-82tvl   1/1     Running       0          79m   app=guestbook,tier=frontend
	frontend-q878l   1/1     Running       0          79m   app=guestbook,tier=frontend
	frontend-test    0/1     Terminating   0          5s    app=guestbook,tier=frontend
	frontend-wh7n4   1/1     Running       0          79m   app=guestbook,tier=frontend
	
	```
	
- **Replicas**

	通过设置 `.spec.replicas` 可以指定要同时运行多少个 Pod。 在任何时间运行 Pod 数量 可能高于或低于 `.spec.replicas` 指定的数量,例如在副本刚刚被增加或减少后，或者 Pod 正在被关闭或者替换。
	
## 1.3. 使用 ReplicaSets 的具体方法

- **删除 ReplicaSet 和它的 Pod**

	要删除 ReplicaSet 和它的所有 Pod， 使用 `kubectl delete` 命令。 默认情况下，垃圾收集器自动删除所有依赖的 Pod。
	
	当使用 REST API 或 `client-go` 库时， 您必须在删除选项中将 `propagationPolicy` 设置为 `Background` 或 `Foreground`。 例如：
	
	```
	kubectl proxy --port=8080
	curl -X DELETE  'localhost:8080/apis/extensions/v1beta1/namespaces/default/replicasets/frontend' \
	> -d '{"kind":"DeleteOptions","apiVersion":"v1","propagationPolicy":"Foreground"}' \
	> -H "Content-Type: application/json"
	Z```